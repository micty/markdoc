
#引入 js 文件

w3c 标准已支持单个 js 文件的引入，即使用标准的 `<script src="xx.js"></script>` 标签语法。
除了使用标准的 `<script>` 标签引入单个 js 文件外，`auto-weber` 自动化开发工具还支持在母版页中使用特定的语法标记批量引入某一类、某个目录或某个模式下的所有 js 文件。


在一些项目中，一个页面引用的 js 模块文件可能会相当多，数量可能会达到几百个，甚至几千个，尤其是在 `单页应用(SPA)` 中。在团队的分工与协作中，
如果采用传统的方式对这些海量的 js 模块文件进行引入和维护，则成本是极高的，也是相当困难的，甚至不可行。
因为团队中的多个成员共同去操作同一个页面文件，以便引入、删除或修改里面的 `<script>` 标签，很容易引发冲突，效率也很低。
因此，我们需要一种机制，通过特定的语法标签，可以批量自动引入特定目录或模式下的所有 js 文件，
在编译生成的页面中自动生成相应的 `<script src="xx.js"></script>` 标签，
这样可以极大地把开发者从繁琐的手工引入 js 文件的工作中解放出来，实现 js 文件的自动引入、删除和修改，让开发者更加专注在业务功能的开发上。

##工作原理

作为讨论，这里简单展示一下 `auto-weber` 是如何处理 js 文件的引入的。
以母版页为输入源，根据 js 文件路径生成相应的 `<script>` 标签，编译生成浏览器可识别的、可运行的页面。

![](data/weber/img/js-flow.png)


> 要引入 js 文件，有 **静态引入** 和 **动态引入** 两种方式。   
静态引入是基础的、标准的单个引入方式，适用于具体某个 js 文件的引入。  
动态引入是扩展的、批量的引入方式，适用于某一类、某个目录或某个模式下的所有 js 文件的引入。  

##静态引入
静态引入是基础的、标准的单个引入方式，适用于具体某个 js 文件的引入。  

静态引入就是 w3c 标准支持的方式，即类似 `<script src="index.js"></script>` 的方式。
`auto-weber` 自动化开发工具会解析和处理这样的静态引入，读取对应的 js 文件，生成内容相关的 `md5` 摘要串，然后以 `query` 的方式拼接到 `src` 属性值的后面。
假如 `index.js` 的内容生成的 `md5` 值是 `F0DF609B50C7645F47DDB465EC1E1EA9`，则取前 4 位 `F0DF`，生成以下标签：

``` html
<script src="index.js?F0DF"></script>
```

通过以文件内容的摘要作为查询字符串，可以有效解决缓存和刷新的效率问题。
只有文件的内容发生了变化，`md5` 摘要和 `src` 中的查询字符串才会发生变化，从而相当于引入了一个新版本的 js 文件，刷新了缓存。
而内容没有变化的 js 文件，则使用之前加载过的缓存版本，从而提高了缓存利用率。



##动态引入

动态引入是扩展的、批量的引入方式，适用于某一类、某个目录或某个模式下的所有 js 文件的引入。
动态引入的 js 文件的顺序是不确定，因此只适用于引入顺序无关的场景。

在某些项目中，需要动态的、批量的自动引入某一类、某个目录或某个模式下的所有 js 文件。  
如在`单页应用(SPA)` 里，采用了 `CMD` 模式编写的 js 模块文件，每个 js 模块文件均是 `define(id, factory)` 函数的调用，它们各自执行的顺序无关紧要。
此时，需要提供一种机制，可以动态的、批量的引入各个 js 模块文件，并且引入的顺序无关紧要的。

如母版页 `index.master.html` 文件有如下代码，批量引用 js 文件：

```html

<!--weber.js.begin-->
<script>
    [
        'modules/**/*.js',
        'routers/**/*.js',
        'index.js',
    ]
</script>
<!--weber.js.end-->

```
假设有如下目录结构：

```pre
modules/
    A.js
    B.js
    C.js

    users/
        API.js
        View.js
```

```pre      
routers/
    R.js
    T.js
```

则给编译后生成的 `index.html` 页面对应部分为：

```html
<!--weber.js.begin-->
<script src="modules/A.js?1195"></script>
<script src="modules/B.js?5C0F"></script>
<script src="modules/C.js?5FD6"></script>
<script src="modules/users/API.js?1F05"></script>
<script src="modules/users/View.js?EF11"></script>
<script src="routers/R.js?DF49"></script>
<script src="routers/T.js?AB83"></script>
<script src="index.js?A0EC"></script>
<!--weber.js.end-->
```

以 `?` 作为分隔符，目标路径中包含两部分：`js` 文件路径部分和 `query` 部分。
`query` 部分是整个 js 文件的内容的 `md5` 值的子串（取前 4 位，如`5C0F`），目的是为了提高了缓存利用效率，减少了刷新等待时间。 

**通过通配符批量自动引入文件的机制非常强大，非常适合团队的分工协作。 **

###排除某些文件

使用通配符模糊指定要引入的文件，具有高适应性，可以针对某一个模式下的所有文件。
有时需要排除此模式下的某些文件，此时可以使用排除表达 `!path` 来指定，例如：

`!modules/users/**/*.js`

即可把 `modules/users/` 目录下及其子目录的所有 js 文件排除掉。



##引入顺序无关

通过动态引入一组 js 文件的顺序是不能确定，它们的顺序跟它们所在的目录和文件名有关，并且按照一定的排序规则进行引入的。

一组什么样的 js 文件才能满足引入顺序无关的要求？
假如有 `n` 个 js 文件需要引入到页面中，`A.js`、`B.js`、`C.js`、...、`N.js`，
为了简化讨论，这里去掉 `?` 及其后面的 `query` 部分。

``` html
<script src="A.js"></script>
<script src="B.js"></script>
<script src="C.js"></script>
...
<script src="N.js"></script>
```

我们知道，常规的引用方式中，js 文件是边引入边解释执行的。   
在上述例子，首先遇到的是 `<script src="A.js">` 标签，就会加载 `A.js` 文件进来，解释和执行它。
完毕后再加载 `B.js`，然后解释和执行它... 最后到 `N.js`。

要满足一组 js 文件引入顺序无关的要求，就要求该组 js 文件的执行顺序没有任何依赖关系，即任意一个 js 文件先执行或后执行都不会影响其它 js 文件的执行过程。

在一些模块化的页面中，如 `CMD` 模式的，使用 `define()` 方法定义的 js 模块文件就具有引入顺序无关的特性。 
因为 `define(id, factory)` 方法仅仅是执行了一个把参数 `id` 和 `factory` 作一个注册关联关系，工厂函数 `factory` 并没有执行。
因此，哪个模块先注册，哪个模块后注册，无关紧要，即它们的执行顺序是无关的，所以这组 js 模块文件是引入顺序无关的。

示例：

`A.js`：
``` javascript
define('A', function (require, module, exports) {
    //process something
    return {  //exports

    };
});

```

`B.js`：

``` javascript
define('B', function (require, module, exports) {
    //process something
    return {  //exports

    };
});

```

**一组 js 文件如果能满足引入(执行)顺序无关的要求，则可以、应该使用动态引入的方式进行批量的、自动化的引入**。  
这样可以极大地提高 js 文件引入到页面的效率，让开发者解放出来做更有意义的事情。

##这样做的好处
- 解放开发者手动管理 js 文件，避免手动引入、修改和移除 js 文件，节省开发者时间。
- 支持自动插入基于文件内容摘要的查询字符串，有效解决缓存和刷新的版本问题。
- 添加和删除 js 文件，会映射到母版页中，开发者只需要管理好自己的模块 js 文件即可。
- 母版页更简洁，对所引入的 js 文件更清晰可见。
- 减少对母版页的修改，减少文件冲突。


